{% extends 'reviews/base.html' %}
{% load static %}

{% block title %}Modifier Ticket{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'reviews/css/modification-ticket.css' %}">
{% endblock %}

{% block content %}
<section class="loginSection">
    <div class="login-box">
        <p id="titleModif">Modifier le ticket</p>

        <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {{ form.non_field_errors }}

            <div class="containerReview">
                <div class="user-box imageContainer">
                    {% if ticket.image %}
                    <img src="{{ ticket.image.url }}" alt="Image actuelle du ticket" id="ticket-current-image">
                    {% else %}
                    <img src="" alt="Aucune image" id="ticket-current-image" style="display:none;">
                    {% endif %}

                    <!-- Bouton (icône) qui déclenche le file input -->
                    <button type="button" id="trigger-image-picker" class="edit-icon-btn" aria-label="Changer l'image">
                        <iconify-icon class="edit-icon" icon="lucide:edit" width="23" height="23"></iconify-icon>
                    </button>

                    <!-- Input fichier caché -->
                    <input type="file" name="image" id="id_image" accept="image/*" class="image-upload-input">
                </div>

                <div class="containerDetail">
                    <div class="user-box">
                        {{ form.title.errors }}
                        {{ form.title }}
                        <label for="{{ form.title.id_for_label }}">Titre</label>
                    </div>
                    <div class="ticket-metadata">
                        <p class="ticket-data">{{ ticket.time_created|date:"d/m/Y" }}</p>
                        <p class="ticket-data">Auteur : {{ ticket.user.username }}</p>
                    </div>
                    <div>
                        <div class="user-box">
                            {{ form.description.errors }}
                            {{ form.description }}
                            <label for="{{ form.description.id_for_label }}">Description</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Champs éditables -->




            <!-- (image déjà gérée ci-dessus, pas besoin de {{ form.image }} répété) -->

            <div class="button-box">
                <a href="{% url 'feed' %}">
                    <span></span><span></span><span></span><span></span>
                    Annuler
                </a>
                <button type="submit" class="submit-btn">
                    <span></span><span></span><span></span><span></span>
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const trigger = document.getElementById('trigger-image-picker');
        const input = document.getElementById('id_image');
        const img = document.getElementById('ticket-current-image');

        if (trigger && input && img) {
            trigger.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    img.src = url;
                    if (img.style.display === 'none') {
                        img.style.display = 'block';
                    }
                }
            });
        }
    });
</script>
{% endblock %}